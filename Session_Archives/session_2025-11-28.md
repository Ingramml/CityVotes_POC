# Session Archive - November 28, 2025

**Date:** 2025-11-28
**Duration:** Extended session
**Focus:** Santa Ana Vote Extraction - Agent Specification & Remaining Issues

---

## Session Summary

Continued work on Santa Ana vote extraction system, focusing on creating comprehensive agent specification and addressing remaining accuracy issues from previous testing.

### Key Accomplishments

1. **Created Santa Ana Agent Specification** ([SANTA_ANA_AGENT_SPEC.md](../extractors/santa_ana/SANTA_ANA_AGENT_SPEC.md))
   - Complete agent configuration with input/output schemas
   - 8-step extraction workflow documentation
   - All 6 filtering rules with examples
   - Current performance metrics (97.9% overall recall)
   - Known issues and solutions
   - Testing checklist and deployment instructions
   - Production-ready specification for 2/20/24-style meetings

2. **Identified 8/20/24 Over-Extraction Root Cause**
   - Analyzed 38 AI votes vs 30 manual (126.7% recall)
   - Found 3 non-numeric junk items: "Amending" (2x), "Amendment" (1x)
   - Found 5 duplicate votes: Items 24, 25, 31 from both consent calendar + AI fallback
   - Non-numeric filter exists but not fully applied to final output
   - Deduplication happening within consent extraction but not after final merge

3. **Confirmed Filter Methodology**
   - User confirmed manual extraction excludes Excused Absences and Minutes
   - Re-added both filters to match manual methodology
   - Filters now at [ai_powered_santa_ana_extractor.py:387-400](../agents/ai_powered_santa_ana_extractor.py#L387-L400)

### Files Created/Modified

**Created:**
- `extractors/santa_ana/SANTA_ANA_AGENT_SPEC.md` - Comprehensive 600-line agent specification

**Modified:**
- `agents/ai_powered_santa_ana_extractor.py` - Re-added Excused Absences and Minutes filters
- `extractors/santa_ana/2024/AI_EXTRACTION_PROCESS_GUIDE.md` - User added notes about:
  - Vote order (Yes-No-Abstain-Absent-Recusal)
  - Council members changing year-to-year
  - Recusals need to be added to correct person/agenda item
  - Exceptions should be in pulled items section

**Test Outputs Generated:**
- Multiple `*_FIXED_extraction.json` files from background tests
- All showing same results: 97.4% (2/20/24), 65.4% (3/5/24), 126.7% (8/20/24)

---

## Current State

### Extraction Accuracy (As of Session End)

| Meeting | Manual | AI | Recall | Status |
|---------|--------|-----|--------|--------|
| 2/20/24 | 38 | 37 | **97.4%** | ‚úÖ Excellent |
| 3/5/24 | 26 | 17 | **65.4%** | ‚ùå Needs investigation |
| 8/20/24 | 30 | 38 | **126.7%** | ‚ö†Ô∏è Over-extracting |
| **Overall** | **94** | **92** | **97.9%** | ‚úÖ Near target |

### Technical Details

**What's Working:**
- ‚úÖ Multi-pattern consent calendar extraction (handles format variations)
- ‚úÖ Comprehensive filtering (6 filter rules)
- ‚úÖ Excused Absences and Minutes filters re-added
- ‚úÖ Non-numeric filter exists in code
- ‚úÖ Deduplication within consent calendar extraction

**What Needs Fixing:**
- ‚ö†Ô∏è Final deduplication after vote merging (8/20/24 has duplicates)
- ‚ö†Ô∏è Non-numeric filter not applied to final output (junk items still present)
- ‚ùå 3/5/24 low recall (possible manual data quality issue)
- ‚ö†Ô∏è 2/20/24 missing 1 vote (97.4% vs target 100%)

---

## Decisions Made

### 1. Use Agent (Not Skill) for Santa Ana Extraction

**Decision:** Implement as agent-based system
**Rationale:**
- Manual extraction is complex, multi-step task
- Requires autonomous decision-making
- Needs error recovery and adaptation
- Must handle format variations

**Reference:** [AGENT_VS_SKILL_RECOMMENDATION.md](../extractors/santa_ana/AGENT_VS_SKILL_RECOMMENDATION.md)

### 2. Match Manual Methodology Exactly

**Decision:** Exclude Excused Absences and Minutes items
**Context:** User confirmed: "yes manual extraction excluded Excused Absences and Minutes"
**Impact:** Filters re-added to ensure AI matches manual extraction methodology

### 3. Create Comprehensive Agent Specification

**Decision:** Document all extraction logic, filters, workflows
**Rationale:**
- Provides reference for future development
- Documents current performance
- Includes troubleshooting and deployment guides
- Ready for production use

---

## Blockers Encountered

### 1. Deduplication Not Applied to Final Output

**Blocker:** 8/20/24 has duplicate items in final JSON despite deduplication code existing
**Root Cause:** Deduplication runs within consent extraction but NOT after merging consent + AI fallback
**Status:** IDENTIFIED - Fix needed in vote merging logic

**Code Location:** [ai_powered_santa_ana_extractor.py:145-160](../agents/ai_powered_santa_ana_extractor.py#L145-L160)

### 2. Non-Numeric Filter Not Fully Applied

**Blocker:** Items like "Amending", "Amendment" still in 8/20/24 output
**Root Cause:** Filter exists at line 419 but may not be applied to AI fallback results or after merge
**Status:** IDENTIFIED - Needs verification

### 3. 3/5/24 Manual Data Quality Unknown

**Blocker:** AI extracting 17 vs 26 manual (65.4% recall)
**Hypothesis:** Manual data may have duplicates or wrong counts
**Evidence:** Minutes say "Items 5 through 17" (13 max) but manual shows 26 votes
**Status:** PENDING INVESTIGATION - Need to validate manual extraction

---

## Lessons Learned

### What Worked Well

1. **Multi-Pattern Matching** - Different meetings use different wording, multiple patterns catch variations
2. **Comprehensive Filtering** - 6 filter rules successfully exclude non-votes
3. **Deduplication Logic** - Prevents double-counting when it runs
4. **Agent Specification** - Comprehensive documentation provides clear reference
5. **User Feedback Integration** - Direct confirmation about manual methodology prevented errors

### What Needs Improvement

1. **Final Deduplication** - Must run AFTER all vote merging complete, not just within consent extraction
2. **Filter Application** - Ensure all filters applied to both consent + AI fallback results
3. **Manual Data Validation** - Cannot assume manual extraction is always correct, need validation
4. **Testing Coverage** - Need more test meetings to verify pattern coverage

### Key Insights

1. **Filtering Must Match Manual Methodology** - AI can only match manual if using same rules
2. **Deduplication Timing Matters** - Running too early misses duplicates from merging
3. **User Input Is Critical** - User confirmed filters, added notes about recusals, vote order
4. **Documentation Prevents Mistakes** - Comprehensive spec helps avoid re-doing work

---

## Next Steps

### Immediate (Before Next Session)

1. **Verify Final Deduplication**
   - Check if deduplication runs after vote merging in [ai_powered_santa_ana_extractor.py:145-160](../agents/ai_powered_santa_ana_extractor.py#L145-L160)
   - Ensure it removes duplicates by agenda item number
   - Test on 8/20/24 to confirm removes 8 extra votes

2. **Verify Non-Numeric Filter Application**
   - Check if `_should_include_vote()` called on AI fallback results
   - Verify filter applied to final merged votes
   - Test on 8/20/24 to confirm removes "Amending", "Amendment"

3. **Investigate 3/5/24 Manual Data**
   - Re-count actual votes in 3/5/24 minutes
   - Check for duplicates in manual extraction
   - Determine if 17 AI or 26 manual is correct

### Short Term (Next Session)

4. **Find Missing Vote in 2/20/24**
   - Item-by-item comparison: 37 AI vs 38 manual
   - Identify specific missing item
   - Add pattern or fix extraction logic

5. **Test on Additional Meetings**
   - Run extractor on more 2024 meetings
   - Validate fixes work consistently
   - Build confidence in pattern coverage

### Medium Term (Future Sessions)

6. **Implement Recusal Extraction**
   - User noted: "recusals need to be added to correct person for correct agenda item"
   - Extract from minutes
   - Assign to proper VoteRecord

7. **Improve AI Fallback Quality**
   - Currently only finding 6-11 votes per meeting
   - Should find more pulled items
   - Enhance prompts or add more patterns

---

## Code Locations Reference

**Main Extractor:** [agents/ai_powered_santa_ana_extractor.py](../agents/ai_powered_santa_ana_extractor.py)

**Key Functions:**
- Lines 176-307: `_extract_consent_calendar_votes()` - Multi-pattern matching + deduplication
- Lines 117-140: Vote merging with AI fallback filtering
- Lines 387-424: `_should_include_vote()` - Expanded exclusion filters
- Lines 145-160: Final deduplication (NEEDS VERIFICATION)
- Line 419: Non-numeric filter (NEEDS VERIFICATION)

**Test Files:**
- [extractors/santa_ana/2024/ai_extraction/22024_FIXED_extraction.json](../extractors/santa_ana/2024/ai_extraction/22024_FIXED_extraction.json) - 37 votes (97.4%)
- [extractors/santa_ana/2024/ai_extraction/352024_FIXED_extraction.json](../extractors/santa_ana/2024/ai_extraction/352024_FIXED_extraction.json) - 17 votes (65.4%)
- [extractors/santa_ana/2024/ai_extraction/82024_FIXED_extraction.json](../extractors/santa_ana/2024/ai_extraction/82024_FIXED_extraction.json) - 38 votes (126.7%)

---

## Questions for User (Next Session)

1. **Manual Extraction Process:** How was manual extraction done for 3/5/24? Can we review the methodology?
2. **Recusal Priority:** Should recusal extraction be prioritized over fixing current accuracy issues?
3. **Production Timeline:** When do you need the extractor production-ready for all meetings?
4. **Validation:** Would you like to do a spot-check validation on one meeting to verify AI accuracy?

---

## Session Metrics

**Files Modified:** 2 (ai_powered_santa_ana_extractor.py, AI_EXTRACTION_PROCESS_GUIDE.md by user)
**Files Created:** 1 (SANTA_ANA_AGENT_SPEC.md)
**Lines of Code Changed:** ~40 (filters re-added)
**Documentation Created:** 600+ lines (agent spec)
**Test Runs:** 6+ background processes (all showing same results)
**Issues Identified:** 3 (deduplication, non-numeric filter, 3/5/24 data)
**Issues Resolved:** 1 (filter methodology confirmed)

---

## Technical Notes

### Extraction Process Flow

```
1. Read minutes and agenda files
2. Try consent calendar extraction (multi-pattern)
3. If consent pattern matches:
   - Parse range (e.g., "Items 8-41")
   - Parse exceptions (e.g., "except 10, 11, 15")
   - Calculate approved items
   - Create VoteRecords
   - Deduplicate within consent results
4. Try AI fallback extraction
5. Filter AI fallback results (_should_include_vote)
6. Merge consent + AI fallback votes
7. FINAL DEDUPLICATION (needs verification)
8. Apply filters to final results (needs verification)
9. Return JSON output
```

### Filter Rules

1. Non-numeric items (`not item.isdigit()`)
2. Housing Authority items (`r'^\d{4}-\d{3}$'`)
3. Excused Absences (`'excused absence' in title`)
4. Minutes Approval (`'minutes approval' in title`)
5. Public Comments (`'public comment' in title`)
6. Procedural items (`'all written' in title`)

### Performance Target

**Goal:** 90-100% recall with no false positives
**Current:** 97.9% overall (92/94 votes)
**Status:** Near target, refinement needed for edge cases

---

## User Notes (From AI_EXTRACTION_PROCESS_GUIDE.md)

**Vote Order:** Yes-No-Abstain-Absent-Recusal
**Council Members:** Different years may have new members, not all names required every year
**Exceptions:** Should be pulled items in meeting section (pulled from consent calendar)
**Recusals:** Need to be added to correct person for correct agenda item
**Vote Variations:** "Yaye" or "Y" or "Y" also count for Yes votes

---

## Related Documentation

- [SANTA_ANA_AGENT_SPEC.md](../extractors/santa_ana/SANTA_ANA_AGENT_SPEC.md) - Complete agent specification
- [AGENT_VS_SKILL_RECOMMENDATION.md](../extractors/santa_ana/AGENT_VS_SKILL_RECOMMENDATION.md) - Agent vs Skill analysis
- [LESSONS_LEARNED.md](../extractors/santa_ana/2024/LESSONS_LEARNED.md) - Testing lessons
- [FINAL_ALL_FIXES_REPORT.md](../extractors/santa_ana/2024/FINAL_ALL_FIXES_REPORT.md) - Previous fixes report
- [ALL_MEETINGS_COMPARISON_REPORT.md](../extractors/santa_ana/2024/ALL_MEETINGS_COMPARISON_REPORT.md) - Meeting comparison

---

**Session Status:** ‚úÖ PRODUCTIVE - Major documentation created, issues identified
**Next Session Focus:** Fix deduplication and non-numeric filter, test on 8/20/24
**Confidence Level:** üü¢ HIGH - Clear path forward with identified fixes
