# File Downloader Workflow

A flexible and robust file downloader that can extract URLs from JSON files or directories and download the files automatically. Built as a template inspired by the LA_County workflow.

## Features

- üîç **Flexible JSON parsing**: Supports various JSON structures and nested keys
- üìÇ **Batch processing**: Process single files or entire directories
- üîó **Smart URL extraction**: Use dot notation to specify nested keys
- üì• **Robust downloading**: Built-in retry logic, error handling, and progress tracking
- üè∑Ô∏è **Intelligent naming**: Automatic filename generation from URLs and metadata
- ‚è±Ô∏è **Rate limiting**: Configurable delays between downloads to be respectful
- üîç **Dry run mode**: Preview what would be downloaded before actually downloading

## Installation

```bash
cd file_downloader
pip install -r requirements.txt
```

## Usage

### Basic Usage

```bash
# Download from a single JSON file
python file_downloader.py --input meetings.json --key "Agenda" --output downloads/

# Process all JSON files in a directory
python file_downloader.py --input data_directory/ --key "Minutes" --output docs/

# Use nested keys with dot notation
python file_downloader.py --input meetings.json --key "documents.pdf_url" --output files/
```

### Advanced Usage

```bash
# Dry run to see what would be downloaded
python file_downloader.py --input data.json --key "url" --output downloads/ --dry-run

# Custom delay between downloads (in seconds)
python file_downloader.py --input meetings.json --key "Agenda" --output docs/ --delay 1.0

# Adjust concurrent download workers
python file_downloader.py --input data/ --key "pdf_url" --output files/ --max-workers 5
```

## JSON Structure Support

The downloader supports various JSON structures:

### Simple Array
```json
[
  {"title": "Meeting 1", "agenda_url": "http://example.com/agenda1.pdf"},
  {"title": "Meeting 2", "agenda_url": "http://example.com/agenda2.pdf"}
]
```

### Object with Data Array
```json
{
  "extraction_info": {...},
  "meetings": [
    {"Date": "1/1/2024", "Agenda": "http://example.com/agenda1.pdf"},
    {"Date": "2/1/2024", "Agenda": "http://example.com/agenda2.pdf"}
  ]
}
```

### Nested URLs
```json
{
  "meetings": [
    {
      "title": "City Council Meeting",
      "documents": {
        "agenda_url": "http://example.com/agenda.pdf",
        "minutes_url": "http://example.com/minutes.pdf"
      }
    }
  ]
}
```

## Key Path Examples

- `"agenda_url"` - Direct key access
- `"Agenda"` - Case-sensitive key access  
- `"documents.agenda_url"` - Nested object access
- `"files.pdf"` - Deep nested access

## Examples with Real Data

### Pomona City Council Meetings
```bash
# Download agenda files from Pomona meetings
python file_downloader.py --input ../Pomona_CA/json/ --key "Agenda" --output pomona_agendas/

# Download minutes files
python file_downloader.py --input ../Pomona_CA/json/ --key "Minutes" --output pomona_minutes/
```

### Santa Ana City Council
```bash
# Process Santa Ana JSON files
python file_downloader.py --input ../Santa_Ana_CA/json/ --key "agenda_url" --output santa_ana_docs/
```

### Houston City Council
```bash
# Download from Houston data
python file_downloader.py --input ../Houston/json/ --key "documents.agenda" --output houston_agendas/
```

## Output Structure

Downloaded files are saved with intelligent naming:
- Original filenames when available from URLs
- Generated names using metadata (date, meeting type, index)
- Safe filename characters only
- Duplicate handling (skips existing files)

Example output structure:
```
downloads/
‚îú‚îÄ‚îÄ agenda_2024-01-15_meeting_1.pdf
‚îú‚îÄ‚îÄ minutes_2024-01-15_meeting_1.pdf
‚îú‚îÄ‚îÄ agenda_2024-02-01_meeting_2.pdf
‚îî‚îÄ‚îÄ minutes_2024-02-01_meeting_2.pdf
```

## Error Handling

- **Network errors**: Automatic retry with exponential backoff
- **File errors**: Skip invalid URLs and continue processing
- **JSON errors**: Detailed error reporting for malformed files
- **Progress tracking**: Real-time download statistics and summaries

## Configuration

### Environment Variables
- `HTTP_TIMEOUT`: Request timeout in seconds (default: 30)
- `USER_AGENT`: Custom user agent string
- `VERIFY_SSL`: SSL certificate verification (default: False)

### Command Line Options
- `--dry-run`: Preview mode without downloading
- `--delay`: Seconds between downloads (default: 0.5)
- `--max-workers`: Concurrent download threads (default: 3)

## Compatible with City Data Extraction Project

This downloader is designed to work seamlessly with JSON files generated by:
- Pomona Legistar scraper
- Santa Ana city council extractor  
- Houston meeting scraper
- Any JSON file with URL fields

## Development

### Adding New JSON Structure Support

To support new JSON structures, modify the `parse_json_file` method in the `JSONParser` class:

```python
# Add new container types to the containers list
containers = ['meetings', 'documents', 'data', 'items', 'results', 'your_new_container']
```

### Custom Filename Generation

Override the `create_filename` method in `DownloadWorkflow` class for custom naming logic.

## License

Part of the CityData_extraction project. Use responsibly and respect website terms of service.
